# ğŸ“ å°ˆæ¡ˆçµæ§‹
# â”œâ”€â”€ .gitlab-ci.yml
# â”œâ”€â”€ scrape_jobs/
# â”‚   â””â”€â”€ secure_app.tpl.yml
# â””â”€â”€ README.md

# .gitlab-ci.yml
stages:
  - generate
  - deploy

generate_scrape_config:
  stage: generate
  image: alpine
  before_script:
    - apk add --no-cache gettext openssh
  script:
    - mkdir -p out
    # å°‡å¯†ç¢¼å­˜ç‚º password_fileï¼ˆåªå­˜åœ¨ CI pipelineï¼Œä¸ commitï¼‰
    - echo "$SCRAPE_PASSWORD" > out/${CI_JOB_NAME}_password.txt
    - chmod 600 out/${CI_JOB_NAME}_password.txt
    # å¥—ç”¨è®Šæ•¸æ¨¡æ¿ç”¢ç”Ÿ Prometheus è¨­å®šæª”
    - envsubst < scrape_jobs/secure_app.tpl.yml > out/scrape_config.yml
  artifacts:
    paths:
      - out/

# ä½ å¯ä»¥æŠŠé€™æ­¥é©Ÿæ”¹æˆ Ansibleã€Rsync ç­‰è‡ªå‹•åŒ–å·¥å…·
# ä»¥ä¸‹ç‚º SCP çš„ç°¡å–®æ–¹å¼ï¼š
deploy_to_vm:
  stage: deploy
  image: alpine
  before_script:
    - apk add --no-cache openssh
  script:
    # ä¸Šå‚³ scrape config åˆ° Prometheus çš„ç›®éŒ„ä¸­
    - scp out/scrape_config.yml prometheus@your-vm:/etc/prometheus/scrape_config.yml
    - scp out/${CI_JOB_NAME}_password.txt prometheus@your-vm:/etc/prometheus/secrets/${CI_JOB_NAME}_password.txt
  only:
    - main
  dependencies:
    - generate_scrape_config

# ğŸ–¥ï¸ Prometheus VM ä¸Šçš„åˆå§‹è¨­å®šï¼ˆåƒ…ä¸€æ¬¡ï¼‰
# bash
# è¤‡è£½
# ç·¨è¼¯
# sudo mkdir -p /etc/prometheus/secrets
# sudo chown -R prometheus:prometheus /etc/prometheus/secrets
# sudo chmod -R 700 /etc/prometheus/secrets
