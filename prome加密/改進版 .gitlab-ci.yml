stages:
  - generate

generate_cre_files:
  stage: generate
  image: alpine:latest
  before_script:
    - apk add --no-cache jq
  script:
    - echo "ğŸ“‚ å»ºç«‹ cre_files è³‡æ–™å¤¾"
    - mkdir -p cre_files

    - echo "ğŸ” å¾ passwords.json è§£æç”¢ç”Ÿ .cre æª”æ¡ˆ"
    - |
      error_flag=0  # â›³ è¨˜éŒ„æ˜¯å¦æœ‰è®Šæ•¸éºæ¼
      for key in $(jq -r 'keys[]' passwords.json); do
        var_name=$(jq -r --arg k "$key" '.[$k]' passwords.json)
        var_value=$(printenv "$var_name")

        if [ -z "$var_value" ]; then
          echo "âŒ éŒ¯èª¤ï¼šç’°å¢ƒè®Šæ•¸ $var_name æœªè¨­å®šï¼ˆç”¨æ–¼ $key.creï¼‰"
          error_flag=1
        else
          echo -n "$var_value" > "cre_files/${key}.cre"
          echo "âœ… å·²å»ºç«‹ cre_files/${key}.creï¼ˆä¾†è‡ª $var_nameï¼‰"
        fi
      done

      # ğŸš¨ è‹¥æœ‰ä»»ä¸€è®Šæ•¸ç¼ºå¤±ï¼Œå°±è®“ job å¤±æ•—
      if [ "$error_flag" -ne 0 ]; then
        echo "ğŸš« Job çµæŸï¼šæœ‰æœªè¨­å®šçš„è®Šæ•¸ï¼Œè«‹ç¢ºèª GitLab CI/CD Settings ä¸­çš„è®Šæ•¸"
        exit 1
      fi

  artifacts:
    paths:
      - cre_files/
